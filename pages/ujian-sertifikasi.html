<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ujian Sertifikasi - Cendiks</title>
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="../css/exam.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="site-nav">
    <div class="container">
      <h1 class="logo">Cendiks</h1>
      <ul class="nav-links">
        <li><a href="../index.html" class="nav-link">Beranda</a></li>
        <li><a href="sessions.html" class="nav-link">Sesi Pembelajaran</a></li>
        <li><a href="install.html" class="nav-link">Instalasi Python</a></li>
        <li><a href="ujian-sertifikasi.html" class="nav-link">Ujian Sertifikasi</a></li>
        <li><a href="more.html" class="nav-link">More</a></li>
      </ul>
    </div>
  </nav>

  <div class="container exam-container">
    <!-- Start Screen -->
    <div id="startScreen" class="start-screen">
      <div class="exam-header">
        <h2>üéì Ujian Sertifikasi Python Dasar</h2>
        <p>Uji kemampuan Python Anda dan dapatkan sertifikat resmi dari Cendiks</p>
      </div>

      <div class="exam-rules">
        <h3>üìã Aturan Ujian:</h3>
        <ul>
          <li>Ujian terdiri dari 10 soal pilihan ganda</li>
          <li>Waktu pengerjaan: 15 menit</li>
          <li>Nilai minimum kelulusan: 70%</li>
          <li>Setiap soal bernilai 10 poin</li>
          <li>Anda dapat mengubah jawaban sebelum submit</li>
          <li>Sertifikat akan diberikan jika lulus ujian</li>
        </ul>
      </div>

      <button class="btn btn-primary" onclick="startExam()">
        üöÄ MULAI UJIAN
      </button>
    </div>

    <!-- Exam Screen -->
    <div id="examScreen" style="display: none;">
      <!-- Timer & Info -->
      <div class="exam-header">
        <h3>Ujian Sertifikasi Python</h3>
        <div class="exam-info">
          <div class="info-card">
            <h4>Waktu Tersisa</h4>
            <div class="value timer" id="timer">15:00</div>
          </div>
          <div class="info-card">
            <h4>Soal Terjawab</h4>
            <div class="value" id="answeredCount">0/10</div>
          </div>
          <div class="info-card">
            <h4>Progress</h4>
            <div class="value" id="progressPercent">0%</div>
          </div>
        </div>
      </div>

      <!-- Progress -->
      <div class="progress-container">
        <div class="progress-text">
          <span>Progress Ujian</span>
          <span id="progressText">0 dari 10 soal</span>
        </div>
        <div class="progress">
          <i id="progressBar" style="width: 0%"></i>
        </div>
        <div class="question-nav" id="questionNav"></div>
      </div>

      <!-- Questions -->
      <div id="questionsContainer"></div>

      <!-- Navigation -->
      <div class="nav-buttons">
        <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()" style="display: none;">
          ‚Üê Sebelumnya
        </button>
        <button class="btn btn-secondary" id="nextBtn" onclick="nextQuestion()">
          Selanjutnya ‚Üí
        </button>
        <button class="btn btn-primary" id="submitBtn" onclick="submitExam()" style="display: none;">
          ‚úì Submit Ujian
        </button>
      </div>
    </div>

    <!-- Result Screen -->
    <div id="resultScreen" class="result-container">
      <div class="certificate">
        <div class="certificate-badge">üèÜ</div>
        <h2>Hasil Ujian Anda</h2>
        <div class="score-display" id="finalScore">0</div>
        <div class="result-message" id="resultMessage"></div>
        
        <div class="result-stats">
          <div class="stat-card">
            <h4>Benar</h4>
            <div class="value" style="color: #10b981;" id="correctCount">0</div>
          </div>
          <div class="stat-card">
            <h4>Salah</h4>
            <div class="value" style="color: #ef4444;" id="wrongCount">0</div>
          </div>
          <div class="stat-card">
            <h4>Waktu</h4>
            <div class="value" style="color: #06b6d4;" id="timeUsed">0m</div>
          </div>
        </div>

        <div id="certificateSection" style="display: none;">
          <h3 style="margin: 2rem 0 1rem; color: #f1f5f9;">üéä Selamat! Anda Lulus!</h3>
          <p style="color: #cbd5e1; margin-bottom: 2rem;">
            Sertifikat: <strong>Python Basic Certification</strong><br>
            Tanggal: <strong id="certDate"></strong>
          </p>
          <button class="btn btn-primary" onclick="downloadCertificate()">
            üì• Download Sertifikat
          </button>
        </div>

        <button class="btn btn-secondary" onclick="retakeExam()" style="margin-top: 1.5rem;">
          üîÑ Ulangi Ujian
        </button>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <p>&copy; 2025 Cendiks. Platform belajar Python untuk semua.</p>
  </footer>

  <script>
    let examData = null;
    let questions = [];
    let currentQuestion = 0;
    let answers = [];
    let timeLeft = 0;
    let timerInterval;
    let startTime;
    let examId = 1; // Default exam ID

    // Load exam data from backend
    async function loadExamData() {
      try {
        const response = await fetch(`/api/exam/${examId}/questions/`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          credentials: 'same-origin'
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            examData = data.exam;
            questions = data.questions;
            timeLeft = examData.duration * 60; // Convert to seconds
            initializeExam();
          } else {
            alert('Gagal memuat data ujian: ' + data.message);
          }
        } else if (response.status === 401) {
          alert('Silakan login terlebih dahulu untuk mengikuti ujian');
          window.location.href = 'login.html';
        } else {
          alert('Gagal memuat data ujian');
        }
      } catch (error) {
        console.error('Error loading exam data:', error);
        alert('Terjadi kesalahan saat memuat data ujian');
      }
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function initializeExam() {
      // Initialize exam with loaded data
      document.getElementById('startScreen').style.display = 'block';
      document.getElementById('examScreen').style.display = 'none';
      document.getElementById('resultScreen').classList.remove('active');
    }

    function startExam() {
      document.getElementById('startScreen').classList.add('hidden');
      document.getElementById('examScreen').style.display = 'block';
      
      renderQuestions();
      renderQuestionNav();
      startTimer();
      updateProgress();
      startTime = Date.now();
    }

    function renderQuestions() {
      const container = document.getElementById('questionsContainer');
      container.innerHTML = '';

      questions.forEach((q, index) => {
        const questionCard = document.createElement('div');
        questionCard.className = 'question-card';
        if (index === 0) questionCard.classList.add('active');

        questionCard.innerHTML = `
          <div class="question-number">Soal ${index + 1} dari ${questions.length}</div>
          <div class="question-text">${q.question.replace(/\n/g, '<br>')}</div>
          <div class="options">
            ${q.options.map((opt, i) => `
              <div class="option" data-option-id="${opt.id}" onclick="selectAnswer(${index}, ${opt.id})">
                <div class="option-letter">${String.fromCharCode(65 + i)}</div>
                <div class="option-text">${opt.option_text}</div>
              </div>
            `).join('')}
          </div>
        `;

        container.appendChild(questionCard);
      });
    }

    function renderQuestionNav() {
      const nav = document.getElementById('questionNav');
      nav.innerHTML = questions.map((_, i) => 
        `<div class="question-nav-btn ${i === 0 ? 'current' : ''}" onclick="goToQuestion(${i})">${i + 1}</div>`
      ).join('');
    }

    function selectAnswer(questionIndex, optionId) {
      answers[questionIndex] = optionId;

      const options = document.querySelectorAll('.question-card')[questionIndex].querySelectorAll('.option');
      options.forEach((opt) => {
        opt.classList.toggle('selected', parseInt(opt.getAttribute('data-option-id')) === optionId);
      });

      updateProgress();
      updateQuestionNav();
    }

    function goToQuestion(index) {
      const cards = document.querySelectorAll('.question-card');
      cards.forEach(card => card.classList.remove('active'));
      cards[index].classList.add('active');

      const navBtns = document.querySelectorAll('.question-nav-btn');
      navBtns.forEach(btn => btn.classList.remove('current'));
      navBtns[index].classList.add('current');

      currentQuestion = index;
      updateNavigationButtons();
    }

    function previousQuestion() {
      if (currentQuestion > 0) {
        goToQuestion(currentQuestion - 1);
      }
    }

    function nextQuestion() {
      if (currentQuestion < questions.length - 1) {
        goToQuestion(currentQuestion + 1);
      }
    }

    function updateNavigationButtons() {
      document.getElementById('prevBtn').style.display = currentQuestion > 0 ? 'block' : 'none';
      document.getElementById('nextBtn').style.display = currentQuestion < questions.length - 1 ? 'block' : 'none';
      document.getElementById('submitBtn').style.display = currentQuestion === questions.length - 1 ? 'block' : 'none';
    }

    function updateProgress() {
      const answered = answers.filter(a => a !== null).length;
      const percent = (answered / questions.length * 100).toFixed(0);
      
      document.getElementById('answeredCount').textContent = `${answered}/${questions.length}`;
      document.getElementById('progressPercent').textContent = `${percent}%`;
      document.getElementById('progressText').textContent = `${answered} dari ${questions.length} soal`;
      document.getElementById('progressBar').style.width = `${percent}%`;
    }

    function updateQuestionNav() {
      const navBtns = document.querySelectorAll('.question-nav-btn');
      answers.forEach((answer, i) => {
        if (answer !== null) {
          navBtns[i].classList.add('answered');
        }
      });
    }

    function startTimer() {
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();

        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          submitExam();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      const timer = document.getElementById('timer');
      timer.textContent = display;

      timer.className = 'value timer';
      if (timeLeft <= 60) {
        timer.classList.add('danger');
      } else if (timeLeft <= 300) {
        timer.classList.add('warning');
      }
    }

    async function submitExam() {
      clearInterval(timerInterval);

      let correct = 0;
      answers.forEach((answer, i) => {
        if (answer === questions[i].correct) correct++;
      });

      const score = (correct / questions.length * 100).toFixed(0);
      const timeUsed = examData.duration * 60 - timeLeft;
      const minutesUsed = Math.floor(timeUsed / 60);
      const secondsUsed = timeUsed % 60;

      // Submit results to backend
      try {
        const response = await fetch(`/api/exam/${examId}/submit/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          credentials: 'same-origin',
          body: JSON.stringify({
            answers: answers,
            time_used: timeUsed,
            score: score
          })
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            // Show results
            document.getElementById('examScreen').style.display = 'none';
            document.getElementById('resultScreen').classList.add('active');
            document.getElementById('finalScore').textContent = `${score}%`;
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('wrongCount').textContent = questions.length - correct;
            document.getElementById('timeUsed').textContent = `${minutesUsed}m ${secondsUsed}s`;

            let message = '';
            if (score >= 90) {
              message = 'üåü Luar Biasa! Anda menguasai Python dengan sempurna!';
            } else if (score >= 70) {
              message = '‚úÖ Selamat! Anda lulus ujian dengan baik!';
            } else {
              message = 'üí™ Terus belajar! Anda bisa mencoba lagi!';
            }
            document.getElementById('resultMessage').textContent = message;

            if (score >= 70) {
              document.getElementById('certificateSection').style.display = 'block';
              const today = new Date().toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              });
              document.getElementById('certDate').textContent = today;
            }
          } else {
            alert('Gagal menyimpan hasil ujian: ' + data.message);
          }
        } else {
          alert('Gagal mengirim hasil ujian');
        }
      } catch (error) {
        console.error('Error submitting exam:', error);
        alert('Terjadi kesalahan saat mengirim hasil ujian');
      }
    }

    function retakeExam() {
      currentQuestion = 0;
      answers = new Array(questions.length).fill(null);
      timeLeft = examData ? examData.duration * 60 : 900;

      document.getElementById('resultScreen').classList.remove('active');
      document.getElementById('startScreen').classList.remove('hidden');
    }

    function downloadCertificate() {
      alert('Fitur download sertifikat akan segera hadir! üéì\n\nSertifikat akan dikirim ke email Anda dalam format PDF.');
    }

    updateNavigationButtons();

    // Initialize exam on page load
    loadExamData();
  </script>
</body>
</html>